import { serve } from 'https://deno.land/std@0.177.0/http/server.ts'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

// API Keys from environment
const ALPHA_VANTAGE_KEY = Deno.env.get('ALPHA_VANTAGE_API_KEY');
const COINGECKO_API_URL = 'https://api.coingecko.com/api/v3';

// Fetch real-time stock price
async function getStockPrice(symbol: string): Promise<any> {
  if (!ALPHA_VANTAGE_KEY) {
    return { error: 'API key not configured' };
  }
  
  try {
    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data['Global Quote']) {
      return {
        symbol: data['Global Quote']['01. symbol'],
        price: parseFloat(data['Global Quote']['05. price']),
        change: parseFloat(data['Global Quote']['09. change']),
        changePercent: data['Global Quote']['10. change percent'],
        volume: data['Global Quote']['06. volume'],
        latestTradingDay: data['Global Quote']['07. latest trading day']
      };
    }
    
    return { error: 'No data found' };
  } catch (error: any) {
    console.error('Stock price fetch error:', error);
    return { error: error.message };
  }
}

// Fetch real-time crypto price
async function getCryptoPrice(symbol: string): Promise<any> {
  try {
    // Map common symbols to CoinGecko IDs
    const cryptoMap: Record<string, string> = {
      'BTC': 'bitcoin',
      'ETH': 'ethereum',
      'XRP': 'ripple',
      'SOL': 'solana',
      'ADA': 'cardano',
      'DOT': 'polkadot',
      'AVAX': 'avalanche-2',
      'DOGE': 'dogecoin',
      'MATIC': 'matic-network',
      'LINK': 'chainlink'
    };
    
    const cryptoId = cryptoMap[symbol.toUpperCase()] || symbol.toLowerCase();
    const url = `${COINGECKO_API_URL}/simple/price?ids=${cryptoId}&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true`;
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data[cryptoId]) {
      return {
        symbol: symbol.toUpperCase(),
        name: cryptoId.charAt(0).toUpperCase() + cryptoId.slice(1),
        price: data[cryptoId].usd,
        change24h: data[cryptoId].usd_24h_change?.toFixed(2) || '0.00',
        volume24h: data[cryptoId].usd_24h_vol || 0
      };
    }
    
    return { error: 'Crypto not found' };
  } catch (error: any) {
    console.error('Crypto price fetch error:', error);
    return { error: error.message };
  }
}

serve(async (req: Request) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { message, tradingMode = 'paper', messages: chatHistory = [] } = await req.json()
    
    const ANTHROPIC_API_KEY = Deno.env.get('ANTHROPIC_API_KEY')
    
    if (!ANTHROPIC_API_KEY) {
      throw new Error('ANTHROPIC_API_KEY not configured')
    }
    
    // Enhanced trading responses based on query
    const query = message.toLowerCase();
    let response = '';
    
    // Check for crypto queries (XRP, BTC, ETH, etc.)
    const cryptoSymbols = ['xrp', 'btc', 'bitcoin', 'eth', 'ethereum', 'sol', 'solana', 'ada', 'cardano', 'dot', 'polkadot', 'avax', 'doge', 'dogecoin', 'matic', 'link'];
    const foundCrypto = cryptoSymbols.find(symbol => query.includes(symbol));
    
    if (foundCrypto) {
      // Extract symbol
      let symbol = foundCrypto.toUpperCase();
      if (foundCrypto === 'bitcoin') symbol = 'BTC';
      if (foundCrypto === 'ethereum') symbol = 'ETH';
      if (foundCrypto === 'solana') symbol = 'SOL';
      if (foundCrypto === 'cardano') symbol = 'ADA';
      if (foundCrypto === 'polkadot') symbol = 'DOT';
      if (foundCrypto === 'dogecoin') symbol = 'DOGE';
      
      const cryptoData = await getCryptoPrice(symbol);
      
      if (cryptoData.error) {
        response = `ðŸš¨ Unable to fetch ${symbol} data: ${cryptoData.error}\n\nPlease try again in a moment.`;
      } else {
        const changeEmoji = parseFloat(cryptoData.change24h) >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
        const changeColor = parseFloat(cryptoData.change24h) >= 0 ? 'ðŸŸ¢' : 'ðŸ”´';
        
        response = `${changeEmoji} **${cryptoData.name} (${cryptoData.symbol}) Real-Time Price**

ðŸ’° **Current Price:** $${cryptoData.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 })}
${changeColor} **24h Change:** ${cryptoData.change24h}%
ðŸ“Š **24h Volume:** $${(cryptoData.volume24h / 1e9).toFixed(2)}B

**Market Context:**
â€¢ **Asset Class:** Cryptocurrency
â€¢ **Trading:** 24/7 on major exchanges
â€¢ **Volatility:** High (crypto market)

**${tradingMode === 'paper' ? 'Paper Trading Strategy' : 'Live Trading Notes'}:**
${tradingMode === 'paper' 
  ? `â€¢ Practice with small positions (0.1-1 ${symbol})
â€¢ Study 24h price patterns
â€¢ Track volume spikes and news events
â€¢ Learn technical indicators (RSI, MACD)`
  : `â€¢ **Risk Warning:** Crypto is highly volatile
â€¢ Use stop losses (5-10% below entry)
â€¢ Only invest what you can afford to lose
â€¢ Consider dollar-cost averaging`
}

**Key Risk Factors:**
â€¢ 24/7 market with weekend volatility
â€¢ Regulatory uncertainty
â€¢ Exchange security concerns

*Real-time data from CoinGecko API. Last updated: ${new Date().toLocaleTimeString()}*`;
      }
      
      return new Response(
        JSON.stringify({ 
          response,
          mode: tradingMode,
          timestamp: new Date().toISOString(),
          symbol: symbol,
          price: cryptoData.price,
          change: cryptoData.change24h
        }),
        { 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
        }
      );
    }
    
    // Check for stock queries (extract ticker symbols like AAPL, TSLA, etc.)
    const stockMatch = query.match(/\b([A-Z]{1,5})\b/);
    if (stockMatch) {
      const symbol = stockMatch[1];
      const stockData = await getStockPrice(symbol);
      
      if (stockData.error) {
        // Fall through to default responses if API fails
        console.log(`Stock API error for ${symbol}:`, stockData.error);
      } else {
        const changeEmoji = stockData.change >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
        const changeColor = stockData.change >= 0 ? 'ðŸŸ¢' : 'ðŸ”´';
        
        response = `${changeEmoji} **${symbol} Real-Time Quote**

ðŸ’° **Current Price:** $${stockData.price.toFixed(2)}
${changeColor} **Change:** ${stockData.change >= 0 ? '+' : ''}${stockData.change.toFixed(2)} (${stockData.changePercent})
ðŸ“Š **Volume:** ${(parseInt(stockData.volume) / 1e6).toFixed(1)}M
ðŸ“… **As of:** ${stockData.latestTradingDay}

**${tradingMode === 'paper' ? 'Paper Trading Practice' : 'Live Trading Analysis'}:**
${tradingMode === 'paper' 
  ? `â€¢ Practice position sizing (10-50 shares)
â€¢ Study price action and volume
â€¢ Track daily high/low ranges
â€¢ Learn to set stop losses`
  : `â€¢ Position size: 2-5% of portfolio max
â€¢ Set stop loss at key support levels
â€¢ Monitor pre-market and after-hours
â€¢ Use limit orders for better fills`
}

**Risk Management:**
â€¢ Never risk more than 1-2% per trade
â€¢ Use stop losses on every position
â€¢ Diversify across sectors
â€¢ Keep cash reserves for opportunities

*Real-time data from Alpha Vantage API. Market data is delayed 15-20 minutes.*`;
        
        return new Response(
          JSON.stringify({ 
            response,
            mode: tradingMode,
            timestamp: new Date().toISOString(),
            symbol: symbol,
            price: stockData.price,
            change: stockData.changePercent
          }),
          { 
            headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
          }
        );
      }
    }

    // Keep existing strategy and help responses
    if (query.includes('strategy') || query.includes('how to')) {
      response = `ðŸ’¡ **Trading Strategy Guide**

**${tradingMode === 'paper' ? 'Paper Trading Learning Path' : 'Live Trading Framework'}:**

**1. Risk Management (CRITICAL):**
â€¢ Never risk more than 1-2% per trade
â€¢ Use stop losses on every position
â€¢ Size positions based on volatility

**2. Entry Strategies:**
â€¢ **Breakout:** Enter above resistance with volume
â€¢ **Pullback:** Buy dips to moving average support
â€¢ **Momentum:** Follow strong trending moves

**3. Market Analysis:**
â€¢ Check overall market direction (SPY/QQQ)
â€¢ Verify sector strength before stock picks
â€¢ Use volume to confirm price moves

**${tradingMode === 'paper' ? 'Learning Focus' : 'Execution Tips'}:**
${tradingMode === 'paper'
  ? 'â€¢ Track win/loss ratios\nâ€¢ Practice different timeframes\nâ€¢ Study after-hours reactions'
  : 'â€¢ Use limit orders for better fills\nâ€¢ Monitor pre-market activity\nâ€¢ Keep trading journal'
}

**Key Metrics to Track:**
â€¢ Sharpe ratio (risk-adjusted returns)
â€¢ Maximum drawdown periods
â€¢ Average holding time per position

*${tradingMode === 'paper' ? 'Perfect for learning without risk!' : 'Live trading requires strict discipline.'}*`;

    } else {
      response = `ðŸ¤– **Genesis Trading Advisor Active**

**Market Overview Ready:**
â€¢ **ðŸ“Š Stock Analysis** - Try: "Analyze AAPL" or "MSFT outlook"
â€¢ **ðŸ’° Crypto Insights** - Ask: "Bitcoin analysis" or "crypto trends"
â€¢ **ðŸ“ˆ Strategy Help** - Request: "trading strategy" or "risk management"
â€¢ **ðŸŽ¯ Specific Tickers** - Query any stock symbol for analysis

**${tradingMode === 'paper' ? 'Paper Trading Mode' : 'Live Trading Mode'}:**
${tradingMode === 'paper'
  ? 'Perfect environment for learning and testing strategies without financial risk.'
  : 'Real market analysis for actual trading decisions. Use proper risk management.'
}

**Popular Analysis Requests:**
â€¢ "AAPL technical analysis"
â€¢ "Best trading strategy for beginners"
â€¢ "How to analyze earnings reports"
â€¢ "Risk management techniques"

**What market analysis can I provide for you today?**`;
    }

    return new Response(
      JSON.stringify({ 
        response,
        mode: tradingMode,
        timestamp: new Date().toISOString()
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    )

  } catch (error) {
    console.error('Error:', error)
    return new Response(
      JSON.stringify({ 
        response: "ðŸš¨ Trading advisor service is initializing. Please try your query again in a moment.",
        error: true 
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      }
    )
  }
})
